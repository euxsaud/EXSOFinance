<script>
(()=>{var l={getGlobals:()=>new Promise((t,e)=>{google.script.run.withSuccessHandler(t).withFailureHandler(e).GetGlobals()}),getRecords:()=>new Promise((t,e)=>{google.script.run.withSuccessHandler(o=>{t(JSON.parse(o))}).withFailureHandler(e).GetRecords()}),saveRecord:t=>t?new Promise((e,o)=>{google.script.run.withSuccessHandler(e).withFailureHandler(o).SaveRecord(t)}):{ok:!1},updateRecord:t=>t?new Promise((e,o)=>{google.script.run.withSuccessHandler(e).withFailureHandler(o).UpdateRecord(t)}):{ok:!1},deleteRecord:t=>t?new Promise((e,o)=>{google.script.run.withSuccessHandler(e).withFailureHandler(o).DeleteRecord(t)}):{ok:!1,message:"ID it's not defined"},userSession:(t="get",e,o)=>["get","set","delete"].indexOf(t)===-1?{ok:!1,message:'Method error. Only "get", "set", and "delete" are accepted as valid methods.'}:new Promise((r,a)=>{google.script.run.withSuccessHandler(r).withFailureHandler(a).UserSession(t,e,o)}),getTaxonomies:t=>t?new Promise((e,o)=>{google.script.run.withSuccessHandler(e).withFailureHandler(o).HandleTaxonomy("GET",t)}):{ok:!1,message:"Taxonomy name not defined"},postTaxonomy:(t,e)=>t?e?new Promise((o,r)=>{google.script.run.withSuccessHandler(o).withFailureHandler(r).HandleTaxonomy("POST",t,e)}):{ok:!1,message:"Data not defined"}:{ok:!1,message:"Taxonomy name not defined"},updateTaxonomy:(t,e,o)=>o?t?e?new Promise((r,a)=>{google.script.run.withSuccessHandler(r).withFailureHandler(a).HandleTaxonomy("UPDATE",e,o,t)}):{ok:!1,message:"Taxonomy name not defined"}:{ok:!1,message:"ID taxonomy not defined"}:{ok:!1,message:"Data not defined"},deleteTaxonomy:t=>t?new Promise((e,o)=>{google.script.run.withSuccessHandler(e).withFailureHandler(o).HandleTaxonomy("DELETE",null,null,t)}):{ok:!1,message:"ID taxonomy not defined"}};function h(t){let e=document.querySelector(t||"body")||document.body,o=getComputedStyle(e).backgroundColor||"#ffffff",r=getComputedStyle(e).color||"#000000";return/oklch/.test(o)&&(o=culori.oklch(o),o=culori.formatHex(o)),/oklch/.test(r)&&(r=culori.oklch(r),r=culori.formatHex(r)),{baseBgColor:o,baseTextColor:r}}var m=()=>({DATA:[],BKDATA:[],onwait:!1,opts:{accounts:[],currencies:[],categories:[],transactions:[]},util_FormatCurrency(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:this.filter.currency,minimumFractionDigits:2}).format(t)},filter:{date:{from:null,to:null,formattedFrom:null,formattedTo:null,pickmode:"bymonth"},currency:"USD"},filter_SetDate(t){let e=t.target.value.split("/");if(e.length===2){let[o,r]=e;this.filter.date.from=dateFns.parseISO(o),this.filter.date.to=dateFns.parseISO(r)}else{let o=dateFns.parseISO(e[0]);this.filter.date.from=dateFns.startOfMonth(o),this.filter.date.to=dateFns.endOfMonth(o)}this.filter.date.formattedFrom=dateFns.format(this.filter.date.from,"MMMM dd, yyyy"),this.filter.date.formattedTo=dateFns.format(this.filter.date.to,"MMMM dd, yyyy"),this.filter_Apply()},filter_Apply(){this.DATA=this.BKDATA.filter(t=>{let e=dateFns.parseISO(t.date),o=dateFns.isWithinInterval(e,{start:this.filter.date.from,end:this.filter.date.to}),r=t.currency===this.filter.currency;return o&&r}),this.stats_SetIndicators()},stats:{income:{total:0,transactions:0,style:[]},expense:{total:0,transactions:0,style:[]},investment:{total:0,transactions:0,style:[]},other:{total:0,transactions:0,style:[]},balance:{total:0,profit:0},expensesByCategory:[],expensesByAccount:[],chartPieToColumn:!0},stats_SetIndicators(){let t={balance:{total:0,profit:0}},e={};this.opts.transactions.forEach(a=>{t[a.value]={total:0,transactions:0};let s=this.DATA.filter(u=>u.transaction===a.value),i=parseFloat(s.reduce((u,f)=>u+f.amount,0).toFixed(2));i=a.operator==="add"?i:-i;let n=s.length,d=a.style||[];t[a.value]={total:i,transactions:n,style:d},e[a.value]=s});for(let a in t)t.balance.total+=a==="other"?0:t[a].total;t.balance.total=parseFloat(t.balance.total.toFixed(2)),t.balance.profit=(t.balance.total/parseFloat(t.income.total)*100).toFixed(2);let o=e.expense.reduce((a,s)=>{let i=this.opts.categories.find(n=>n.value.toLowerCase()===s.category.toLowerCase())?.style[0]||"#333333";return a[s.category]||(a[s.category]=[0,i]),a[s.category][0]+=s.amount,a},{});this.stats.expensesByCategory=Object.entries(o).map(([a,[s,i]])=>[a,s,i]);let r=e.expense.reduce((a,s)=>{let i=this.opts.accounts.find(n=>n.value.toLowerCase()===s.account.toLowerCase())?.style[0]||"#333333";return a[s.account]||(a[s.account]=[0,i]),a[s.account][0]+=s.amount,a},{});this.stats.expensesByAccount=Object.entries(r).map(([a,[s,i]])=>[a,s,i]),this.stats={...this.stats,...t}},stats_TotalCard(t="Expense",e){return this.DATA.filter(a=>a.transaction===t&&a.account===e).reduce((a,s)=>a+s.amount,0).toFixed(2)},chart_Init(){google.charts.load("current",{packages:["corechart","line","bar"]}),this.$watch("stats.expensesByCategory",t=>this.chart_ExpensesByCategory(t)),this.$watch("stats.expensesByAccount",t=>this.chart_AccountsExpenses(t)),this.$watch("filter.currency",()=>this.chart_HistoryBalance()),this.$watch("BKDATA",()=>this.chart_HistoryBalance()),new MutationObserver(()=>{this.chart_ExpensesByCategory(),this.chart_AccountsExpenses(),this.chart_HistoryBalance()}).observe(document.body,{attributes:!0,attributeFilter:["data-theme","style"]})},chart_ExpensesByCategory(t){t=t||this.stats.expensesByCategory;let e="category_expenses_charts",o=t.map(i=>i[2]),r=t.map(i=>[i[0],i[1]]),a=["Category","Total Expenses"],s={colors:o,title:"Expenses by Category"};this.DrawPieChart(e,a,r,s)},chart_AccountsExpenses(t){t=t||this.stats.expensesByAccount;let e="accounts_expenses_charts",o=t.map(i=>i[2]),r=t.map(i=>[i[0].toUpperCase(),i[1]]),a=["Account","Total Expenses"],s={colors:o,title:"Expenses by Account"};this.DrawPieChart(e,a,r,s)},chart_HistoryBalance(){let t="history_balance_charts",e=["Date","Income","Expenses","Investments","Other"],o={title:"History of Balance",hAxis:{title:"Date"},vAxis:{title:"Amount"},colors:[this.opts.transactions.find(s=>s.value==="income")?.style[0]||"green",this.opts.transactions.find(s=>s.value==="expense")?.style[0]||"red",this.opts.transactions.find(s=>s.value==="investment")?.style[0]||"yellow",this.opts.transactions.find(s=>s.value==="other")?.style[0]||"gray"]},r={};this.BKDATA.forEach(({date:s,transaction:i,currency:n,amount:d})=>{if(this.filter.currency!==n)return;s=typeof s=="string"?dateFns.parseISO(s):s;let u=dateFns.startOfMonth(s),f=dateFns.format(u,"MM-01-yyyy");r[f]||(r[f]={date:u,[i]:0}),r[f][i]=(r[f][i]||0)+d});let a=Object.values(r).map(s=>{let i=dateFns.format(s.date,"MMM yyyy"),n=s.other||0,d=s.income||0,u=s.expense||0,f=s.investment||0;return[i,d,u,f,n]});this.DrawLineChart(t,e,a,o)},DrawPieChart(t,e,o,r={}){let{baseBgColor:a,baseTextColor:s}=h();o=google.visualization.arrayToDataTable([e,...o]),new google.visualization.NumberFormat({prefix:"$",fractionDigits:2}).format(o,1);let n={pieSliceText:"value",title:"Chart Title Undefined",backgroundColor:"transparent",pieSliceBorderColor:a,titleTextStyle:{color:s},chartArea:{width:"90%",height:"90%"},pieSliceTextStyle:{color:"white",fontSize:12},legend:{position:"right",alignment:"center"},...r};/dark/.test(document.body.getAttribute("data-theme"))&&(n.legend.textStyle={color:s}),new google.visualization.PieChart(document.getElementById(t)).draw(o,n)},DrawLineChart(t,e,o,r={}){let{baseBgColor:a,baseTextColor:s}=h();o=google.visualization.arrayToDataTable([e,...o]);let i=new google.visualization.NumberFormat({prefix:"$",fractionDigits:2});i.format(o,1),i.format(o,2),i.format(o,3);let n={title:"Chart Title Undefined",backgroundColor:"transparent",hAxis:{title:"H Axis Title"},vAxis:{title:"V Axis Title"},titleTextStyle:{color:s},legend:{position:"bottom"},lineWidth:3,...r};n.hAxis.textStyle={color:s},n.vAxis.textStyle={color:s},n.legend.textStyle={color:s},/dark/.test(document.body.getAttribute("data-theme"))&&(n.vAxis.gridlines={color:"#636e72"},n.vAxis.minorGridlines={color:"#2d3436"}),new google.visualization.LineChart(document.getElementById(t)).draw(o,n)},DrawColumnChart(t,e,o,r={}){let{baseBgColor:a,baseTextColor:s}=h();o=google.visualization.arrayToDataTable([e,...o]),new google.visualization.NumberFormat({prefix:"$",fractionDigits:2}).format(o,1);let n={title:"Chart Title Undefined",backgroundColor:"transparent",hAxis:{title:"H Axis Title"},vAxis:{title:"V Axis Title"},titleTextStyle:{color:s},legend:{position:"bottom"},...r};n.hAxis.textStyle={color:s},n.vAxis.textStyle={color:s},n.legend.textStyle={color:s},/dark/.test(document.body.getAttribute("data-theme"))&&(n.vAxis.gridlines={color:"#636e72"},n.vAxis.minorGridlines={color:"#2d3436"}),new google.visualization.ColumnChart(document.getElementById(t)).draw(o,n)},async init(){console.log("KPIS Component Initialized"),this.onwait=!0,this.chart_Init();let t=new Date;this.filter.date.from=dateFns.startOfMonth(t),this.filter.date.to=dateFns.endOfMonth(t),this.filter.date.formattedFrom=dateFns.format(this.filter.date.from,"MMMM dd, yyyy"),this.filter.date.formattedTo=dateFns.format(this.filter.date.to,"MMMM dd, yyyy");let e=await l.getGlobals();this.opts.accounts=e.accounts,this.opts.currencies=e.currencies,this.opts.categories=e.categories,this.opts.transactions=e.transactionMethods;let o=await l.getRecords();this.DATA=o,this.BKDATA=o,this.filter_Apply(),this.stats_SetIndicators(),this.onwait=!1}});var c=new Notyf({ripple:!0,duration:1e4,dismissible:!0,position:{x:"left",y:"bottom"},types:[{type:"warm",background:"linear-gradient(45deg, rgb(239, 253, 33), rgb(255, 0, 0))"}]});var y=()=>({theme:document.body.getAttribute("data-theme"),async toggleTheme(){this.theme=this.theme==="lightgreen"?"dark":"lightgreen",document.body.setAttribute("data-theme",this.theme);let t=await l.userSession("set","theme",this.theme);console.log(t),c[t.ok?"success":"error"](t.message)},init(){console.log("THEME component initialized")}});var p=()=>({DATA:[],BKDATA:[],onwait:!1,opts:{accounts:[],currencies:[],categories:[],transactions:[],groupedCategories:[]},util_FormatDate(t){return dateFns.format(dateFns.parseISO(t),"MMM dd, yyyy")},util_getStyleOption(t,e){let o=this.opts[t],r={backgroundColor:"#bdc3c7",color:"#34495e"};return o?(o=o.find(a=>a.value.toLowerCase()===e.toLowerCase()),o?{backgroundColor:o.style[0],color:o.style[1]}:r):r},filter:{date:{from:null,to:null,formattedFrom:null,formattedTo:null},category:"all",account:"all",transaction:"all",amount:0,currency:"USD",maxAmount:500},filter_Apply(t){if(t){let e=t.target.value;if(t.target.tagName.includes("CALENDAR-")){let[o,r]=e.split("/");this.filter.date.to=dateFns.parseISO(r),this.filter.date.from=dateFns.parseISO(o),this.filter.date.formattedTo=dateFns.format(this.filter.date.to,"MMM dd, yyyy"),this.filter.date.formattedFrom=dateFns.format(this.filter.date.from,"MMM dd, yyyy")}}this.DATA=this.BKDATA.filter(e=>{let o=dateFns.parseISO(e.date),r=parseFloat(this.filter.amount),a=dateFns.isWithinInterval(o,{start:this.filter.date.from,end:this.filter.date.to}),s=this.filter.account==="all"||e.account.toLowerCase()===this.filter.account.toLowerCase(),i=this.filter.category==="all"||e.category.toLowerCase()===this.filter.category.toLowerCase(),n=this.filter.transaction==="all"||e.transaction.toLowerCase()===this.filter.transaction.toLowerCase(),d=r===0||r>=this.filter.maxAmount||e.amount<=r,u=e.currency.toLowerCase()===this.filter.currency.toLowerCase();return a&&i&&s&&n&&d&&u})},form_Modal:document.querySelector("#add_record_modal"),form_El:null,form_saveAndAddOther:!1,form_editMode:!1,form_fields:{date:dateFns.format(new Date,"yyyy-MM-dd"),category:"",payee:"",description:"",account:"",transaction:"",amount:null,currency:"USD"},form_Reset(){this.form_fields={date:dateFns.format(new Date,"yyyy-MM-dd"),category:"",payee:"",description:"",account:"",transaction:"",amount:null,currency:"USD"},this.form_editMode=!1},form_Edit(t){t.date=dateFns.format(t.date,"yyyy-MM-dd"),this.form_editMode=!0,this.form_fields=t,this.form_Modal.showModal()},async form_Delete(t){confirm(`Are you sure you want to delete the record with ID ${t.id}?`)&&(this.onwait=!0,(await l.deleteRecord(t.id)).ok?(this.BKDATA=this.BKDATA.filter(r=>r.id!==t.id),this.DATA=this.BKDATA,this.filter_Apply(),c.success("Success deleting record")):c.error("Error deleting record"),this.onwait=!1)},async form_Submit(){if(this.onwait=!0,this.form_fields.amount=parseFloat(this.form_fields.amount),this.form_editMode)(await l.updateRecord(this.form_fields)).ok?(this.BKDATA.map(e=>(e.id===this.form_fields.id&&(e=this.form_fields),e)),this.DATA=this.BKDATA,this.form_Reset(),this.filter_Apply(),this.form_Modal.close()):c.error("Error saving record");else{let t=await l.saveRecord(this.form_fields);t.ok?(this.form_saveAndAddOther||this.form_Modal.close(),this.BKDATA.unshift(t.data),this.BKDATA.sort((e,o)=>new Date(o.date)-new Date(e.date)),this.DATA=this.BKDATA,this.form_Reset(),this.filter_Apply()):c.error("Error saving record")}this.onwait=!1},async init(){console.log("HOME component initialized"),this.onwait=!0;let t=new Date;this.filter.date.from=dateFns.startOfMonth(t),this.filter.date.to=dateFns.endOfMonth(t),this.filter.date.formattedFrom=dateFns.format(this.filter.date.from,"MMM dd, yyyy"),this.filter.date.formattedTo=dateFns.format(this.filter.date.to,"MMM dd, yyyy"),this.form_El=this.$refs.MainForm;let e=await l.getGlobals();this.opts.accounts=e.accounts,this.opts.currencies=e.currencies,this.opts.categories=e.categories,this.opts.groupedCategories=e.groupedCategories,this.opts.transactions=e.transactionMethods;let o=await l.getRecords();this.DATA=o,this.BKDATA=o,this.filter_Apply(),this.onwait=!1}});var g=()=>({DATA:[],BKDATA:[],onwait:!1,page:"accounts",opts:{accounts:[],currencies:[],customCategories:[]},util_FormatCurrency(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:this.filter?.currency||"USD",minimumFractionDigits:2}).format(t)},account_editMode:!1,account_fields:{value:"",provider:"",type:"",limit:null,currency:"USD",bgColor:"#000000",textColor:"#FFFFFF"},async account_formSubmit(){let{id:t,value:e,provider:o,type:r,limit:a,currency:s,bgColor:i,textColor:n}=this.account_fields,d={value:e,provider:o,type:r,limit:a,currency:s,style:[i,n]};if(this.onwait=!0,this.account_editMode)(await l.updateTaxonomy(t,"account",d)).ok?(this.opts.accounts=this.opts.accounts.map(f=>f.id===t?{...d,id:t}:f),c.success(`Account ${e} was updated successfully`)):c.error(`The account ${e} could not be updated`);else{if(this.opts.accounts.some(f=>f.value===e)){alert(`Account "${e}" already exists!`),this.onwait=!1;return}let u=await l.postTaxonomy("account",d);u.ok?(this.opts.accounts.push({...d,id:u.id}),c.success(`The "${e}" account was added successfully`)):c.error(`The account "${e}" could not be added`)}this.account_resetForm(),this.onwait=!1},account_resetForm(){this.account_editMode=!1,this.account_fields={value:"",provider:"",type:"",limit:null,currency:"USD",bgColor:"#000000",textColor:"#FFFFFF"}},async account_delete(t){if(!confirm(`Are you sure you want to delete the account "${t.value}"?`))return;this.onwait=!0,(await l.deleteTaxonomy(t.id)).ok?(this.opts.accounts=this.opts.accounts.filter(r=>r.value!==t.value),c.success("Accound deleted successfully")):c.error("The account could not be deleted."),this.onwait=!1},account_edit(t){this.account_editMode=!0,this.account_fields={...t,bgColor:t.style[0],textColor:t.style[1]}},cat_editMode:!1,cat_fields:{value:"",bgColor:"#000000",textColor:"#FFFFFF"},async cat_formSubmit(){let{id:t,value:e,bgColor:o,textColor:r}=this.cat_fields,a={id:t,value:e,style:[o,r],groupOf:"Custom Category"};if(this.onwait=!0,this.cat_editMode)(await l.updateTaxonomy(t,"customcat",a)).ok?(this.opts.customCategories=this.opts.customCategories.map(i=>i.value===this.cat_fields.value?a:i),c.success(`Custom category "${e}" updated successfully`)):c.error(`Custom catoegory "${e}" could not be updated`);else{if(this.opts.customCategories.some(i=>i.value===this.cat_fields.value)){alert(`Category "${this.cat_fields.value}" already exists!`),this.onwait=!1;return}let s=await l.postTaxonomy("customcat",a);s.ok?(this.opts.customCategories.push({...a,id:s.id}),c.success(`Custom category "${e}" was added successfully`)):c.error(`Custom category ${e} could not be added`)}this.cat_resetForm(),this.onwait=!1},cat_resetForm(){this.cat_editMode=!1,this.cat_fields={value:"",bgColor:"#000000",textColor:"#FFFFFF"}},async cat_delete(t){if(!confirm(`Are you sure you want to delete the category "${t.value}"?`))return;this.onwait=!0,(await l.deleteTaxonomy(t.id)).ok?(this.opts.customCategories=this.opts.customCategories.filter(r=>r.value!==t.value),c.success("Custom category deleted successfully")):c.error("Custom category could not be deleted"),this.onwait=!1},cat_edit(t){this.cat_editMode=!0,this.cat_fields={...t,bgColor:t.style[0],textColor:t.style[1]}},async init(){console.log("Config component initialized"),this.onwait=!0;let t=await l.getGlobals();this.opts.accounts=t.accounts,this.opts.currencies=t.currencies;let e=await l.getTaxonomies("customcat");this.opts.customCategories=e,console.log(this.opts),this.onwait=!1}});document.addEventListener("alpine:init",()=>{Alpine.data("KPIS",m),Alpine.data("THEME",y),Alpine.data("HOME",p),Alpine.data("CONFIGS",g)});document.addEventListener("DOMContentLoaded",()=>{console.log("DOM fully loaded and parsed \u{1F525}")});})();

</script>